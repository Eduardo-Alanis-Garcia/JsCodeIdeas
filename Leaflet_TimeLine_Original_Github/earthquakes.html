<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet.timeline — Earthquakes</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <!-- corrige la importación de la fuente -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <!-- Asegúrate de que este fichero exista o usa un CDN válido -->
  <script src="./leaflet.timeline.js"></script>

  <style>
    html, body { margin:0; padding:0; font-family:"Open Sans", sans-serif; height:100%; }
    #info { position:fixed; top:0; left:0; bottom:0; width:20vw; padding:1em; overflow:auto; }
    #map  { position:fixed; top:0; left:20vw; bottom:0; right:0; }
    .leaflet-bottom.leaflet-left { width:100%; }
    .leaflet-control-container .leaflet-timeline-controls {
      box-sizing:border-box; width:100%; margin:0 0 15px 0;
    }
  </style>
</head>
<body>
  <div id="info">
    <h1>Earthquakes</h1>
    <h2>Over the Last 24 Hours</h2>
    <h3>Currently displayed:</h3>
    <ul id="displayed-list"></ul>
  </div>
  <div id="map"></div>

  <script>
  (function() {
    const osmUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const osmAttrib = '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors';
    const osm = L.tileLayer(osmUrl, { maxZoom: 18, attribution: osmAttrib, noWrap: true });

    const map = L.map("map", {
      layers: [osm],
      center: [0,0],
      zoom: 3,
      maxBounds: [[90, -180], [-90, 180]]
    });

    function updateList(timeline) {
      const displayed = timeline.getLayers();
      const list = document.getElementById("displayed-list");
      list.innerHTML = "";
      displayed.forEach(function(layer) {
        const li = document.createElement("li");
        // Comprobar que existe la propiedad antes de usarla
        const title = (layer.feature && layer.feature.properties && layer.feature.properties.title) || "Unknown";
        li.textContent = title;
        list.appendChild(li);
      });
    }

    // Función que será llamada por el JSONP de USGS:
    window.eqfeed_callback = function(data) {
      const getInterval = function(feature) {
        // 1,800,000 ms = 30 minutos
        return {
          start: feature.properties.time,
          end: feature.properties.time + feature.properties.mag * 1800000
        };
      };

      const timelineControl = L.timelineSliderControl({
        formatOutput: function(date) { return new Date(date).toString(); }
      });

      const timeline = L.timeline(data, {
        getInterval: getInterval, // <- corregido el nombre
        pointToLayer: function (feature, latlng) {
          const mag = feature.properties.mag || 0;
          const hue_min = 120, hue_max = 0;
          const hue = (mag / 10) * (hue_max - hue_min) + hue_min;
          return L.circleMarker(latlng, {
            radius: mag * 3,
            color: "hsl(" + hue + ", 100%, 50%)",
            fillColor: "hsl(" + hue + ", 100%, 50%)",
            fillOpacity: 0.8
          }).bindPopup(
            '<strong>' + (feature.properties.title || 'Terremoto') + '</strong><br/>' +
            'Magnitude: ' + mag + '<br/>' +
            '<a href="' + (feature.properties.url || '#') + '" target="_blank">More info</a>'
          );
        }
      });

      timelineControl.addTo(map);
      timelineControl.addTimelines(timeline);
      timeline.addTo(map);
      timeline.on("change", function(e) { updateList(e.target); });
      updateList(timeline);
    };
  })();
  </script>

  <!-- JSONP del USGS: llamará a window.eqfeed_callback(data) -->
  <script src="https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojsonp"></script>
</body>
</html>
